name: Split RS Stocks by Exchange

on:
  workflow_call:
  workflow_dispatch:

jobs:
  split-stocks:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------------
      # 1. Checkout repo (normal checkout, no ref override)
      # ---------------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false

      # ---------------------------------------------------------------
      # 2. Setup Python (or whatever tools your script uses)
      # ---------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # ---------------------------------------------------------------
      # 3. Run your script that creates RS split output files
      # ---------------------------------------------------------------
      - name: Run Split Script
        run: |
          python scripts/split_rs_script.py    # (replace with your actual script)

      # ---------------------------------------------------------------
      # 4. Prepare Git for pushing new files
      # ---------------------------------------------------------------
      - name: Configure Git and sync before commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # ðŸ”¥ CRITICAL FIX:
          # Bring repo up to date with REMOTE before creating new commit.
          git fetch origin main

          # Soft reset â†’ keeps your newly generated files but updates repo to latest main
          git reset --soft origin/main

      # ---------------------------------------------------------------
      # 5. Commit + Push results safely
      # ---------------------------------------------------------------
      - name: Commit and Push
        run: |
          # Stage only expected output files
          git add -f RS_Data/rs_stocks_BSE.csv \
                   RS_Data/rs_stocks_NSE.csv \
                   RS_Data/rs_stocks_NSE_75.csv \
                   archive/

          # Commit only if changes exist
          git commit -m "Daily update + archived results $(date -u '+%Y-%m-%d %H:%M UTC')" || exit 0

          # Push (will NEVER be rejected now)
          git push origin main
