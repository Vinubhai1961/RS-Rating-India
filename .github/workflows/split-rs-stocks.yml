name: Split RS Stocks by Exchange

on:
  workflow_dispatch:

jobs:
  split-stocks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with push permissions)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Split rs_stocks.csv by Exchange
        run: |
          echo "Checking for RS_Data/rs_stocks.csv..."
          if [ ! -f RS_Data/rs_stocks.csv ]; then
            echo "❌ ERROR: RS_Data/rs_stocks.csv not found."
            echo "Workflow stopped — no file to split."
            exit 0
          fi

          echo "File found. Starting split process..."

          python3 << 'EOF'
          import pandas as pd
          
          # Load original CSV
          df = pd.read_csv("RS_Data/rs_stocks.csv")
          
          # Clean column names defensively
          df.columns = [c.strip().lower() for c in df.columns]
          
          # Identify exchange column
          exchange_col = None
          for c in df.columns:
              if "exchange" in c:
                  exchange_col = c
                  break
          
          if exchange_col is None:
              raise Exception("Exchange column not found — cannot split file.")
          
          # Split by exchange values
          bse = df[df[exchange_col].str.contains("BSE", case=False, na=False)]
          nse = df[df[exchange_col].str.contains("NSE", case=False, na=False)]
          
          # Save into RS_Data/
          bse.to_csv("RS_Data/rs_stocks_BSE.csv", index=False)
          nse.to_csv("RS_Data/rs_stocks_NSE.csv", index=False)
          
          print("✔ Split complete:")
          print(f"  BSE rows: {len(bse)}")
          print(f"  NSE rows: {len(nse)}")
          
          EOF

      - name: Commit changes (only if updated)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add RS_Data/rs_stocks_BSE.csv RS_Data/rs_stocks_NSE.csv

          if git diff --staged --quiet; then
            echo "No changes detected — nothing to commit."
            exit 0
          fi

          git commit -m "Auto-split RS stocks ($(date -u '+%Y-%m-%d %H:%M UTC'))"
          git push

          echo "✔ Files committed successfully."
