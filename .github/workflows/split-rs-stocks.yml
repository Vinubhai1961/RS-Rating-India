name: Split RS Stocks by Exchange

on:
 
  workflow_dispatch:        # still allows manual run

jobs:
  split-stocks:
  
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the exact commit from Calculate RS
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}   # ← guarantees rs_stocks.csv exists
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pandas
        run: pip install pandas

      - name: Split rs_stocks.csv using Ticker suffix (.BO / .NS)
        run: |
          python << 'EOF'
          import pandas as pd
          import os

          file_path = "rs_stocks.csv"          # your Calculate RS workflow saves it at root
          if not os.path.exists(file_path):
              print("rs_stocks.csv not found in repository root!")
              exit(1)

          df = pd.read_csv(file_path)

          # Make sure Ticker column exists and is string
          if 'Ticker' not in df.columns:
              print("Column 'Ticker' not found!")
              print("Available columns:", list(df.columns))
              exit(1)

          df['Ticker'] = df['Ticker'].astype(str).str.upper()

          # Split by suffix
          bse = df[df['Ticker'].str.endswith('.BO')]
          nse = df[df['Ticker'].str.endswith('.NS')]

          os.makedirs("RS_Data", exist_ok=True)

          bse.to_csv("RS_Data/rs_stocks_BSE.csv", index=False)
          nse.to_csv("RS_Data/rs_stocks_NSE.csv", index=False)

          print(f"Split completed")
          print(f"  → BSE (.BO): {len(bse)} stocks")
          print(f"  → NSE (.NS): {len(nse)} stocks")
          EOF

      - name: Commit & push split files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add RS_Data/rs_stocks_BSE.csv RS_Data/rs_stocks_NSE.csv

          if git diff --staged --quiet; then
            echo "No changes in split files"
            exit 0
          fi

          git commit -m "Auto-split: rs_stocks_BSE + rs_stocks_NSE ($(date -u '+%Y-%m-%d %H:%M UTC'))"
          git push

          echo "Split files pushed successfully!"
